package com.caruseapp.Service;

import android.app.Service;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Binder;
import android.os.Handler;
import android.os.IBinder;
import android.util.Base64;
import android.util.Log;
import android.widget.Toast;
import android_serialport_api.SerialPortFinder;
import androidx.annotation.Nullable;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.caruseapp.LocationUse.BdGpsCtrl.SerialHelper;
import com.caruseapp.LocationUse.bean.AssistBean;
import com.caruseapp.LocationUse.bean.ComBean;
import com.caruseapp.LocationUse.cache.DataCache;
import com.caruseapp.LocationUse.sender.LocalAnalyserSender;
import com.caruseapp.LocationUse.sender.Sender;
import com.caruseapp.LocationUse.sender.UdpBroadCastSender;
import com.caruseapp.locating.IOface.DataAnalyser;
import com.caruseapp.locating.IOface.DataCalcCallback;
import com.caruseapp.locating.IOface.DataInterface;
import com.caruseapp.locating.IOface.Locate;

import java.io.*;
import java.security.InvalidParameterException;
import java.text.DecimalFormat;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.Queue;

public class LocationService extends Service implements DataCalcCallback {

//public class LocationService extends Service {
//    Spinner SpinnerBaudRateCOMA;
//    RadioButton radioButtonTxt, radioButtonHex;
//    String res;
//    String result_str="";

//    double[][] route_points = {{116.300278, 39.959698}, {116.300355, 39.959528}, {116.30038, 39.959483}, {116.300211, 39.959441}, {116.299988, 39.959399}, {116.299768, 39.959358}, {116.299629, 39.959314},
//            {116.299629, 39.959265}, {116.299629, 39.959215}, {116.299932, 39.959272}, {116.30025, 39.959334}, {116.300563, 39.959396}, {116.30088, 39.959458}, {116.301197, 39.95952}, {116.301452, 39.95957},
//            {116.301764, 39.959632}, {116.302072, 39.959708}, {116.302381, 39.959785}, {116.302691, 39.959863}, {116.302999, 39.959939}, {116.30324, 39.960015}, {116.303446, 39.960089}, {116.303651, 39.960163},
//            {116.303863, 39.96024}, {116.30415, 39.960358}, {116.304439, 39.960477}, {116.304812, 39.960644}, {116.305425, 39.960914}, {116.306042, 39.96119}, {116.306641, 39.961483}, {116.306771, 39.961499},
//            {116.306941, 39.961544}, {116.307224, 39.961668}, {116.307505, 39.96179}, {116.30779, 39.961915}, {116.307939, 39.961898}, {116.307943, 39.961722}, {116.307945, 39.961532}, {116.307945, 39.961285},
//            {116.30796, 39.961113}, {116.307978, 39.960939}, {116.307999, 39.960766}, {116.308049, 39.960595}, {116.308098, 39.960425}, {116.308148, 39.960254}, {116.308198, 39.960085}, {116.308248, 39.959913},
//            {116.308281, 39.95979}, {116.308306, 39.959693}, {116.308331, 39.959593}, {116.308356, 39.959494}, {116.30838, 39.959397}, {116.308405, 39.959299}, {116.308447, 39.95913}, {116.308491, 39.958956},
//            {116.308531, 39.958787}, {116.308573, 39.958616}, {116.308614, 39.958444}, {116.30863, 39.95834}, {116.30865, 39.958221}, {116.308688, 39.958031}, {116.30872, 39.95786}, {116.308754, 39.957677},
//            {116.3088, 39.957468}, {116.308834, 39.957296}, {116.308866, 39.957128}, {116.308893, 39.956974}, {116.308905, 39.956878}, {116.308921, 39.956778}, {116.308938, 39.956679}, {116.308955, 39.956579},
//            {116.308977, 39.956432}, {116.309003, 39.956258}, {116.309023, 39.956089}, {116.309041, 39.955912}, {116.309057, 39.95574}, {116.309075, 39.955564}, {116.30909, 39.955391}, {116.309105, 39.955219},
//            {116.309119, 39.955044}, {116.309124, 39.95487}, {116.309127, 39.954697}, {116.309131, 39.954522}, {116.309135, 39.954346}, {116.309149, 39.954191}, {116.309174, 39.953785}, {116.309217, 39.953266},
//            {116.309267, 39.952759}, {116.309304, 39.952241}, {116.309343, 39.951703}, {116.309381, 39.951161}, {116.30943, 39.950935}, {116.309481, 39.95076}, {116.30953, 39.950592}, {116.30958, 39.950425},
//            {116.309615, 39.950252}, {116.309632, 39.950079}, {116.309651, 39.949864}, {116.309673, 39.949591}, {116.309693, 39.949338}, {116.309713, 39.949092}, {116.309733, 39.948843}, {116.309754, 39.948591},
//            {116.309766, 39.948422}, {116.309779, 39.948247}, {116.30979, 39.948068}, {116.3098, 39.947894}, {116.30981, 39.947708}, {116.30982, 39.947545}, {116.309831, 39.947374}, {116.309845, 39.947166},
//            {116.309857, 39.946988}, {116.30986, 39.946809}, {116.309858, 39.946647}, {116.309853, 39.946472}, {116.309853, 39.946312}, {116.309853, 39.946142}, {116.309857, 39.945958}, {116.309861, 39.945788},
//            {116.309866, 39.945618}, {116.309871, 39.945426}, {116.309876, 39.945235}, {116.309881, 39.945025}, {116.309888, 39.944853}, {116.309898, 39.944676}, {116.309907, 39.944502}, {116.309918, 39.944311},
//            {116.309927, 39.944137}, {116.309948, 39.943789}, {116.309973, 39.9434}, {116.309981, 39.943132}, {116.309988, 39.942888}, {116.309995, 39.942632}, {116.310003, 39.942397}, {116.310016, 39.942143},
//            {116.310019, 39.941953}, {116.310018, 39.941778}, {116.310017, 39.941612}, {116.310016, 39.941429}, {116.310015, 39.941254}, {116.310015, 39.941082}, {116.310014, 39.940905}, {116.310013, 39.94073},
//            {116.310012, 39.940556}, {116.310011, 39.94038}, {116.31001, 39.940206}, {116.310009, 39.94003}, {116.310008, 39.939857}, {116.310007, 39.939684}, {116.310006, 39.93951}, {116.310007, 39.939336},
//            {116.31002, 39.939153}, {116.31002, 39.938903}, {116.31002, 39.938657}, {116.31002, 39.938404}, {116.310023, 39.938133}, {116.310044, 39.937646}, {116.310049, 39.937481}, {116.310054, 39.937308},
//            {116.310059, 39.937132}, {116.310065, 39.936961}, {116.310071, 39.936783}, {116.310074, 39.936573}, {116.310074, 39.93632}, {116.310079, 39.936143}, {116.310085, 39.935965}, {116.310089, 39.935742},
//            {116.310089, 39.935341}, {116.310092, 39.935081}, {116.310095, 39.934826}, {116.3101, 39.934517}, {116.310108, 39.934109}, {116.310113, 39.933778}, {116.310117, 39.933533}, {116.31012, 39.933282},
//            {116.310123, 39.933032}, {116.310127, 39.932784}, {116.31013, 39.932532}, {116.310134, 39.932285}, {116.310134, 39.932153}, {116.310133, 39.932102}, {116.310132, 39.932052}, {116.310131, 39.932002},
//            {116.31013, 39.931954}, {116.310129, 39.931903}, {116.310128, 39.931853}, {116.310126, 39.9318}, {116.310125, 39.931748}, {116.310124, 39.931699}, {116.310123, 39.931648}, {116.310122, 39.931599},
//            {116.310121, 39.931548}, {116.31012, 39.931499}, {116.310119, 39.931449}, {116.310118, 39.9314}, {116.310116, 39.93135}, {116.310115, 39.931297}, {116.310114, 39.931248}, {116.310113, 39.9312},
//            {116.310112, 39.931148}, {116.310111, 39.9311}, {116.31011, 39.93105}, {116.310109, 39.931}, {116.310107, 39.93095}, {116.310106, 39.9309}, {116.310105, 39.930849}, {116.310104, 39.930799},
//            {116.310103, 39.930749}, {116.310102, 39.930699}, {116.310101, 39.930651}, {116.3101, 39.930601}, {116.310099, 39.930549}, {116.310097, 39.9305}, {116.310094, 39.930186}, {116.310089, 39.929673},
//            {116.310093, 39.929424}, {116.310097, 39.929168}, {116.310097, 39.928808}, {116.310095, 39.928556}, {116.310094, 39.928317}, {116.310093, 39.928061}, {116.310092, 39.927818}, {116.31009, 39.927565},
//            {116.310089, 39.927321}, {116.310089, 39.927072}, {116.31009, 39.92678}, {116.310094, 39.926383}, {116.310097, 39.925999}, {116.310101, 39.925825}, {116.310106, 39.925651}, {116.31011, 39.925477},
//            {116.310115, 39.925299}, {116.310119, 39.925106}, {116.310124, 39.924934}, {116.310128, 39.924741}, {116.310132, 39.924492}, {116.310136, 39.924254}, {116.310138, 39.923972}, {116.31014, 39.923732},
//            {116.310142, 39.923482}, {116.310144, 39.923242}, {116.310146, 39.922998}, {116.310148, 39.922743}, {116.310149, 39.922501}, {116.310147, 39.922004}, {116.310143, 39.921445}, {116.310139, 39.920919},
//            {116.310135, 39.920361}, {116.310129, 39.919825}, {116.310129, 39.919281}, {116.310131, 39.918741}, {116.310134, 39.918138}, {116.310137, 39.917627}, {116.31014, 39.917092}, {116.310143, 39.916551},
//            {116.310146, 39.916014}, {116.310148, 39.915476}, {116.310151, 39.914925}, {116.310153, 39.914378}, {116.310156, 39.913826}, {116.310158, 39.913276}, {116.310158, 39.912723}, {116.310159, 39.9122},
//            {116.310165, 39.911671}, {116.31018, 39.911074}, {116.310182, 39.910538}, {116.310184, 39.909982}, {116.310185, 39.909449}, {116.310186, 39.908881}, {116.310187, 39.908351}, {116.31019, 39.907814},
//            {116.310193, 39.907267}, {116.310196, 39.906757}, {116.310196, 39.906187}, {116.310196, 39.90567}, {116.3102, 39.905125}, {116.310204, 39.904537}, {116.310204, 39.903982}, {116.310204, 39.903371},
//            {116.310204, 39.902857}, {116.310204, 39.902316}, {116.310209, 39.901767}, {116.310213, 39.901228}, {116.310217, 39.900684}, {116.310219, 39.900134}, {116.310219, 39.899585}, {116.310219, 39.899154},
//            {116.310219, 39.898744}, {116.310219, 39.898436}, {116.310219, 39.898265}, {116.310219, 39.898089}, {116.310219, 39.897896}, {116.310219, 39.897726}, {116.310219, 39.897544}, {116.310219, 39.897377},
//            {116.310219, 39.897194}, {116.310219, 39.897028}, {116.310219, 39.896852}, {116.310219, 39.896677}, {116.310219, 39.896497}, {116.310223, 39.896259}, {116.310228, 39.896018}, {116.310233, 39.895769},
//            {116.310238, 39.895516}, {116.31024, 39.895243}, {116.310234, 39.894932}, {116.310234, 39.894682}, {116.310234, 39.894429}, {116.310234, 39.894172}, {116.310234, 39.893911}, {116.310235, 39.893719},
//            {116.310236, 39.893521}, {116.310237, 39.893354}, {116.310238, 39.893178}, {116.310239, 39.892995}, {116.31024, 39.892828}, {116.310241, 39.892651}, {116.310242, 39.892479}, {116.310243, 39.892288},
//            {116.310244, 39.892106}, {116.310245, 39.891939}, {116.310247, 39.891762}, {116.310248, 39.891581}, {116.310249, 39.891415}, {116.31025, 39.891196}, {116.31025, 39.89091}, {116.310251, 39.890671}, {116.310252, 39.890419}, {116.310253, 39.890163}, {116.310254, 39.889913}, {116.310254, 39.889643}, {116.310255, 39.889395}, {116.310256, 39.889141}, {116.310257, 39.8889}, {116.310258, 39.888702}, {116.31026, 39.88852}, {116.310262, 39.888351}, {116.310264, 39.888179}, {116.310266, 39.887988}, {116.310268, 39.887811}, {116.31027, 39.887638}, {116.310272, 39.887459}, {116.310272, 39.887224}, {116.310272, 39.886978}, {116.310274, 39.88678}, {116.31028, 39.886587}, {116.310285, 39.886406}, {116.310293, 39.886251}, {116.310305, 39.886076}, {116.310318, 39.885906}, {116.310337, 39.885731}, {116.310354, 39.885566}, {116.310368, 39.885383}, {116.310392, 39.88521}, {116.310421, 39.884994}, {116.310451, 39.88474}, {116.310479, 39.884503}, {116.310508, 39.884255}, {116.310539, 39.884}, {116.310561, 39.883694}, {116.310594, 39.883394}, {116.310619, 39.883199}, {116.310628, 39.883024}, {116.310635, 39.882851}, {116.310652, 39.882641}, {116.310679, 39.88236}, {116.310699, 39.882107}, {116.310721, 39.881829}, {116.310757, 39.881497}, {116.310805, 39.881095}, {116.310852, 39.880702}, {116.310888, 39.880437}, {116.310938, 39.880073}, {116.310989, 39.879695}, {116.311043, 39.879298}, {116.311099, 39.878883}, {116.31115, 39.878506}, {116.311179, 39.878252}, {116.311206, 39.878014}, {116.311233, 39.877769}, {116.311262, 39.87752}, {116.311291, 39.877261}, {116.311322, 39.876986}, {116.311349, 39.876749}, {116.311378, 39.876491}, {116.311406, 39.876245}, {116.311433, 39.876001}, {116.311461, 39.875753}, {116.311489, 39.875505}, {116.311517, 39.875257}, {116.311555, 39.874932}, {116.311602, 39.874539}, {116.311646, 39.874168}, {116.311699, 39.873636}, {116.31173, 39.873341}, {116.311748, 39.873174}, {116.311768, 39.873}, {116.31181, 39.872628}, {116.311866, 39.872131}, {116.311919, 39.871662}, {116.311938, 39.871495}, {116.311959, 39.871306}, {116.311983, 39.871088}, {116.312004, 39.870905}, {116.312035, 39.870635}, {116.312062, 39.870403}, {116.312092, 39.870141}, {116.312122, 39.869878}, {116.312153, 39.869617}, {116.31218, 39.869381}, {116.312211, 39.869119}, {116.312241, 39.868861}, {116.312269, 39.868616}, {116.312299, 39.868364}, {116.312328, 39.868116}, {116.312356, 39.867871}, {116.312387, 39.867588}, {116.312414, 39.867343}, {116.312441, 39.8671}, {116.312469, 39.866845}, {116.312488, 39.86667}, {116.312508, 39.866487}, {116.312526, 39.866315}, {116.312545, 39.866138}, {116.312564, 39.865966}, {116.312584, 39.865776}, {116.312603, 39.865601}, {116.312622, 39.865425}, {116.312641, 39.86525}, {116.312659, 39.865077}, {116.312721, 39.864643}, {116.312748, 39.864481}, {116.312777, 39.86431}, {116.312809, 39.864116}, {116.312836, 39.863953}, {116.312974, 39.86353}, {116.313092, 39.863168}, {116.313151, 39.862997}, {116.313216, 39.862812}, {116.313316, 39.862564}, {116.313394, 39.862394}, {116.313476, 39.862217}, {116.313569, 39.862023}, {116.313893, 39.86144}, {116.314256, 39.860891}, {116.314646, 39.860371}, {116.315063, 39.859874}, {116.315553, 39.85933}, {116.315993, 39.858858}, {116.316397, 39.858425}, {116.316828, 39.857939}, {116.317226, 39.857495}, {116.31763, 39.857044}, {116.31802, 39.856608}, {116.318465, 39.85611}, {116.318934, 39.855604}, {116.319419, 39.855072}, {116.319821, 39.854632}, {116.320245, 39.854167}, {116.320774, 39.853583}, {116.321303, 39.853007}, {116.321703, 39.852577}, {116.322227, 39.852041}, {116.322665, 39.85168}, {116.323179, 39.851293}, {116.323811, 39.850872}, {116.324332, 39.850566}, {116.324956, 39.850241}, {116.325619, 39.84995}, {116.326297, 39.849696}, {116.327077, 39.849449}, {116.327901, 39.849251}, {116.32869, 39.849097}, {116.329472, 39.848984}, {116.330352, 39.848927}, {116.331349, 39.84892}, {116.332282, 39.848919}, {116.33309, 39.848919}, {116.333817, 39.848919}, {116.334525, 39.848917}, {116.335236, 39.848907}, {116.336025, 39.848898}, {116.336811, 39.84889}, {116.337466, 39.848886}, {116.338179, 39.848885}, {116.338974, 39.848885}, {116.339742, 39.848885}, {116.340444, 39.848885}, {116.341202, 39.848896}, {116.342033, 39.848956}, {116.342724, 39.849021}, {116.343396, 39.849116}, {116.343913, 39.849195}, {116.344311, 39.84927}, {116.344603, 39.84933}, {116.344937, 39.849406}, {116.345335, 39.849508}, {116.345567, 39.849567}, {116.345811, 39.84963}, {116.346019, 39.849683}, {116.346263, 39.849746}, {116.346621, 39.849846}, {116.346977, 39.849944}, {116.347276, 39.850027}, {116.347568, 39.850108}, {116.347937, 39.850211}, {116.348404, 39.850334}, {116.348925, 39.850472}, {116.349194, 39.850547}, {116.349403, 39.850607}, {116.349619, 39.850665}, {116.349843, 39.850725}, {116.35009, 39.850791}, {116.350317, 39.850852}, {116.350536, 39.850911}, {116.35078, 39.85098}, {116.351003, 39.851043}, {116.351252, 39.851114}, {116.351471, 39.851175}, {116.351686, 39.851236}, {116.351904, 39.851297}, {116.352141, 39.851364}, {116.35235, 39.851423}, {116.352591, 39.851491}, {116.3528, 39.85155}, {116.353011, 39.85161}, {116.353233, 39.851672}, {116.353442, 39.851731}, {116.353695, 39.851803}, {116.353912, 39.851864}, {116.354119, 39.851919}, {116.354348, 39.851981}, {116.354567, 39.852041}, {116.354824, 39.852113}, {116.355045, 39.852176}, {116.355274, 39.85224}, {116.355505, 39.852305}, {116.355715, 39.852365}, {116.355944, 39.852429}, {116.356157, 39.852489}, {116.356366, 39.852548}, {116.356788, 39.852665}, {116.357325, 39.852814}, {116.357914, 39.852977}, {116.3584, 39.853111}, {116.358936, 39.85326}, {116.359509, 39.853418}, {116.360041, 39.853565}, {116.36055, 39.853706}, {116.360921, 39.853804}, {116.361419, 39.853947}, {116.361967, 39.854104}, {116.36233, 39.854206}, {116.36258, 39.854274}, {116.362825, 39.854341}, {116.363041, 39.854399}, {116.363322, 39.854476}, {116.363513, 39.854528}, {116.363581, 39.854547}, {116.363643, 39.854564}, {116.363713, 39.854583}, {116.363782, 39.854602}, {116.363845, 39.854619}, {116.363915, 39.854639}, {116.363979, 39.854656}, {116.36405, 39.854676}, {116.36413, 39.854698}, {116.3642, 39.854717}, {116.364271, 39.854736}, {116.364339, 39.854755}, {116.364407, 39.854774}, {116.364477, 39.854793}, {116.36455, 39.854813}, {116.364627, 39.854834}, {116.3647, 39.854854}, {116.364773, 39.854874}, {116.364842, 39.854893}, {116.364915, 39.854913}, {116.364989, 39.854934}, {116.365055, 39.854952}, {116.365137, 39.854975}, {116.365215, 39.854996}, {116.365285, 39.855015}, {116.365353, 39.855034}, {116.365433, 39.855056}, {116.365507, 39.855076}, {116.365578, 39.855096}, {116.365645, 39.855114}, {116.365731, 39.855138}, {116.365802, 39.855157}, {116.36588, 39.855179}, {116.366085, 39.855236}, {116.366339, 39.855307}, {116.366595, 39.855379}, {116.366827, 39.855444}, {116.367097, 39.855516}, {116.36738, 39.855595}, {116.367638, 39.855665}, {116.367889, 39.855733}, {116.368123, 39.855796}, {116.368782, 39.855974}, {116.369198, 39.856098}, {116.369567, 39.856206}, {116.369943, 39.856305}, {116.370362, 39.856416}, {116.370834, 39.856525}, {116.37109, 39.856574}, {116.371361, 39.856627}, {116.371656, 39.856684}, {116.371856, 39.85672}, {116.372023, 39.856745}, {116.372176, 39.856768}, {116.372328, 39.856791}, {116.372468, 39.856812}, {116.372622, 39.856835}, {116.372763, 39.856857}, {116.373037, 39.856887}, {116.373602, 39.856937}, {116.373982, 39.856968}, {116.374265, 39.85699}, {116.3749, 39.857024}, {116.375157, 39.857032}, {116.375461, 39.857042}, {116.375741, 39.857048}, {116.376019, 39.857047}, {116.37632, 39.857046}, {116.376623, 39.857046}, {116.376893, 39.857045}, {116.377169, 39.857044}, {116.377422, 39.857044}, {116.377721, 39.857043}, {116.377976, 39.857042}, {116.378254, 39.857042}, {116.378515, 39.857041}, {116.378787, 39.85704}, {116.379057, 39.85704}, {116.379335, 39.857039}, {116.379614, 39.857038}, {116.379889, 39.857037}, {116.380163, 39.857037}, {116.380442, 39.857038}, {116.380707, 39.857039}, {116.38097, 39.857039}, {116.38131, 39.85704}, {116.381699, 39.857044}, {116.381969, 39.857042}, {116.382256, 39.85704}, {116.382663, 39.857039}, {116.383068, 39.857038}, {116.383447, 39.857038}, {116.383827, 39.857036}, {116.384101, 39.857029}, {116.384459, 39.857024}, {116.38485, 39.857023}, {116.385284, 39.857021}, {116.385583, 39.857021}, {116.385867, 39.85702}, {116.386135, 39.85702}, {116.386418, 39.85702}, {116.386686, 39.857019}, {116.386977, 39.857019}, {116.387247, 39.857019}, {116.387539, 39.857018}, {116.387815, 39.857018}, {116.388365, 39.857016}, {116.388877, 39.857014}, {116.389153, 39.857014}, {116.389541, 39.857012}, {116.389965, 39.857009}, {116.390359, 39.857006}, {116.39059, 39.857006}, {116.390749, 39.857006}, {116.390917, 39.857006}, {116.391072, 39.857006}, {116.39124, 39.857006}, {116.391397, 39.857006}, {116.391566, 39.857006}, {116.392156, 39.857001}, {116.393008, 39.856993}, {116.393841, 39.856985}, {116.394592, 39.856995}, {116.395207, 39.857028}, {116.395678, 39.857043}, {116.395984, 39.857042}, {116.396285, 39.85704}, {116.396582, 39.857038}, {116.396857, 39.857037}, {116.397158, 39.857035}, {116.397438, 39.857033}, {116.397736, 39.857032}, {116.398017, 39.85703}, {116.398319, 39.857028}, {116.398602, 39.857027}, {116.39892, 39.857025}, {116.399205, 39.857023}, {116.399531, 39.857022}, {116.400096, 39.857021}, {116.400657, 39.85702}, {116.400959, 39.857017}, {116.401247, 39.857015}, {116.40156, 39.857012}, {116.401858, 39.857009}, {116.402164, 39.857006}, {116.402448, 39.857004}, {116.402755, 39.857001}, {116.403042, 39.856998}, {116.403352, 39.856995}, {116.403771, 39.856994}, {116.404212, 39.856992}, {116.404596, 39.856991}, {116.405021, 39.856988}, {116.405449, 39.856983}, {116.405901, 39.856987}, {116.406345, 39.856991}, {116.406761, 39.856995}, {116.407238, 39.856995}, {116.407587, 39.856998}, {116.407899, 39.857002}, {116.408207, 39.857006}, {116.408506, 39.857011}, {116.408819, 39.857015}, {116.409164, 39.857018}, {116.409622, 39.857018}, {116.409982, 39.857018}, {116.410295, 39.857019}, {116.4106, 39.85702}, {116.410924, 39.857021}, {116.411198, 39.857021}, {116.411898, 39.857021}, {116.412949, 39.857026}, {116.413999, 39.857033}, {116.415025, 39.85704}, {116.416104, 39.857047}, {116.417111, 39.857062}, {116.418165, 39.85707}, {116.419316, 39.857093}, {116.420263, 39.857175}, {116.421399, 39.857353}, {116.422345, 39.857516}, {116.423342, 39.857688}, {116.424255, 39.857845}, {116.425171, 39.858013}, {116.426379, 39.858163}, {116.427447, 39.858246}, {116.428504, 39.858308}, {116.429532, 39.85838}, {116.430576, 39.85845}, {116.431586, 39.858514}, {116.432604, 39.85858}, {116.433691, 39.858656}, {116.434712, 39.858726}, {116.435814, 39.858799}, {116.436873, 39.858856}, {116.438046, 39.858894}, {116.439034, 39.858894}, {116.440209, 39.858876}, {116.441294, 39.858844}, {116.44239, 39.858823}, {116.443516, 39.858805}, {116.44446, 39.858791}, {116.445643, 39.858802}, {116.446624, 39.858864}, {116.447744, 39.859046}, {116.448746, 39.859268}, {116.449776, 39.859604}, {116.450589, 39.859938}, {116.451633, 39.860476}, {116.45253, 39.861049}, {116.453171, 39.861427}, {116.453681, 39.86149}, {116.454033, 39.861485}, {116.454349, 39.86148}, {116.454688, 39.861475}, {116.455011, 39.86147}, {116.455482, 39.861452}, {116.455858, 39.861389}, {116.456304, 39.861143}, {116.456794, 39.860799}, {116.457335, 39.860389}, {116.457701, 39.860105}, {116.457921, 39.859929}, {116.458153, 39.859743}, {116.458372, 39.859569}, {116.458603, 39.859384}, {116.458821, 39.859209}, {116.459056, 39.859021}, {116.459327, 39.85881}, {116.459551, 39.858634}, {116.45979, 39.858448}, {116.460293, 39.858058}, {116.460765, 39.857693}, {116.461119, 39.857416}, {116.461457, 39.857148}, {116.461788, 39.856886}, {116.462152, 39.856598}, {116.462471, 39.856345}, {116.462815, 39.856073}, {116.463215, 39.855756}, {116.464008, 39.855134}, {116.4647, 39.854591}, {116.464954, 39.854386}, {116.465191, 39.854194}, {116.465426, 39.854005}, {116.465668, 39.853809}, {116.465913, 39.853611}, {116.466135, 39.853432}, {116.466374, 39.85324}, {116.46661, 39.853049}, {116.46709, 39.852644}, {116.467453, 39.852336}, {116.467677, 39.852143}, {116.467804, 39.852031}, {116.467935, 39.851916}, {116.468055, 39.851809}, {116.468193, 39.851687}, {116.468323, 39.851573}, {116.468454, 39.851457}, {116.468584, 39.851342}, {116.468713, 39.851229}, {116.468839, 39.851117}, {116.468971, 39.851001}, {116.469095, 39.850892}, {116.469236, 39.850766}, {116.469583, 39.850446}, {116.469898, 39.850156}, {116.470233, 39.849847}, {116.47039, 39.8497}, {116.470521, 39.849577}, {116.470646, 39.849458}, {116.470766, 39.849345}, {116.470909, 39.84921}, {116.471035, 39.849091}, {116.471156, 39.848976}, {116.471285, 39.848855}, {116.47141, 39.848737}, {116.471533, 39.84862}, {116.471662, 39.848499}, {116.471783, 39.848384}, {116.471914, 39.848261}, {116.472031, 39.848149}, {116.472167, 39.848022}, {116.472296, 39.8479}, {116.472418, 39.847784}, {116.472555, 39.847654}, {116.472686, 39.847531}, {116.472813, 39.847411}, {116.473323, 39.846932}, {116.47386, 39.846426}, {116.474353, 39.845963}, {116.474877, 39.84547}, {116.475369, 39.845007}, {116.475681, 39.844704}, {116.476119, 39.844298}, {116.476334, 39.844104}, {116.476965, 39.843511}, {116.477838, 39.842679}, {116.478753, 39.841803}, {116.479538, 39.841046}, {116.480295, 39.840339}, {116.481004, 39.839671}, {116.481783, 39.838933}, {116.482452, 39.838257}, {116.483251, 39.837544}, {116.483997, 39.836848}, {116.4848, 39.836068}, {116.485481, 39.835407}, {116.486315, 39.834585}, {116.487106, 39.833837}, {116.487774, 39.833206}, {116.488663, 39.832368}, {116.489408, 39.83167}, {116.490186, 39.830951}, {116.490932, 39.830274}, {116.49174, 39.829569}, {116.492558, 39.828856}, {116.493352, 39.82818}, {116.494138, 39.827532}, {116.495008, 39.826823}, {116.495897, 39.826104}, {116.496758, 39.825439}, {116.497643, 39.824741}, {116.498667, 39.823974}, {116.499712, 39.823204}, {116.500579, 39.822588}, {116.501612, 39.821861}, {116.502589, 39.821202}, {116.503609, 39.820526}, {116.50461, 39.819863}, {116.505466, 39.81932}, {116.506486, 39.818675}, {116.507445, 39.818078}, {116.50839, 39.817492}, {116.509443, 39.816836},
//            {116.510285, 39.816307}, {116.511314, 39.815643}, {116.512329, 39.814987}, {116.512633, 39.81477}, {116.513358, 39.814285}, {116.513894, 39.813922}, {116.514191, 39.813713}, {116.514482, 39.813507}};
//    private String TAG = "LocationService";
//    private boolean quit;
//    String str ="";
//    private int hight = 0;
//    private LocationBinder binder = new LocationBinder();
//    @Nullable
//    @Override
//    public IBinder onBind(Intent intent) {
//        Log.i(TAG,"Bind");
//        return binder;
//    }

//    @Override
//    public void onCreate() {
//        System.out.println("onCreate location service");
//
//        super.onCreate();
//        startServce();
//    }

    /**
     * 模拟下载任务，每秒钟更新一次
     */
//    public void startServce(){
//        HashMap<String ,String> map = new HashMap<>();
//        final int[] count = {0};
//
//        map.put("height","76");
//        map.put("state","walk");
//        Handler location_handler = new Handler();
//        Runnable runnable = new Runnable(){
//            @Override
//            public void run() {
//                boolean hasGPS = true;
//
//                DecimalFormat df = new DecimalFormat("########.00");
////四舍五入
//
//                map.put("gpsConnection",String.valueOf(hasGPS));
//                map.put("method","JJ");
//                int len = route_points.length;
//                map.put("stepCounter", String.valueOf(hight));
//                if(count[0] <len){
//                    map.put("latitude",String.valueOf(route_points[count[0]][1]));
//                    map.put("longitude",String.valueOf(route_points[count[0]][0]));
//                    count[0]++;
//                }else {
//                    map.put("latitude",String.valueOf(route_points[len-1][1]));
//                    map.put("longitude",String.valueOf(route_points[len-1][0]));
//                }
//
//                hight += 5;
//                hight = hight % 200;
//                res = JSON.toJSONString(map);
//                location_handler.postDelayed(this, 1000);
//            }
//        };
//
//        location_handler.post(runnable);
//    }

    //
//    public class LocationBinder extends Binder {
//        /**
//         * 获取当前Service的实例
//         * @return
//         */
//        public LocationService getService(){
//            return LocationService.this;
//        }
//    }
    /**
     * 解除绑定时调用
     * @return
     */
//    @Override
//    public boolean onUnbind(Intent intent) {
//        Log.i(TAG, "Service is invoke onUnbind");
//        return super.onUnbind(intent);
//    }
//    public String getLocation() {
//        return res;
//    }
//    @Override
//    public void onDestroy() {
//        Log.i(TAG, "Service is invoke Destroyed");
//        this.quit = true;
//        super.onDestroy();
//
//        closeUdpSender();
//    }
//
//    private void closeUdpSender() {
//    }



    String res;
    String result_str="";
    SerialControl ComA;
    SerialControl ComB;
    DispQueueThread DispQueue;
    SerialPortFinder mSerialPortFinder;
    private DataInterface _dataInterface;
    AssistBean AssistData;
    int iRecLines = 0;
    private Sender _sender;

    double[][] route_points = {{116.300278, 39.959698}, {116.300355, 39.959528}, {116.30038, 39.959483}, {116.300211, 39.959441}, {116.299988, 39.959399}, {116.299768, 39.959358}, {116.299629, 39.959314},
            {116.299629, 39.959265}, {116.299629, 39.959215}, {116.299932, 39.959272}, {116.30025, 39.959334}, {116.300563, 39.959396}, {116.30088, 39.959458}, {116.301197, 39.95952}, {116.301452, 39.95957},
            {116.301764, 39.959632}, {116.302072, 39.959708}, {116.302381, 39.959785}, {116.302691, 39.959863}, {116.302999, 39.959939}, {116.30324, 39.960015}, {116.303446, 39.960089}, {116.303651, 39.960163},
            {116.303863, 39.96024}, {116.30415, 39.960358}, {116.304439, 39.960477}, {116.304812, 39.960644}, {116.305425, 39.960914}, {116.306042, 39.96119}, {116.306641, 39.961483}, {116.306771, 39.961499},
            {116.306941, 39.961544}, {116.307224, 39.961668}, {116.307505, 39.96179}, {116.30779, 39.961915}, {116.307939, 39.961898}, {116.307943, 39.961722}, {116.307945, 39.961532}, {116.307945, 39.961285},
            {116.30796, 39.961113}, {116.307978, 39.960939}, {116.307999, 39.960766}, {116.308049, 39.960595}, {116.308098, 39.960425}, {116.308148, 39.960254}, {116.308198, 39.960085}, {116.308248, 39.959913},
            {116.308281, 39.95979}, {116.308306, 39.959693}, {116.308331, 39.959593}, {116.308356, 39.959494}, {116.30838, 39.959397}, {116.308405, 39.959299}, {116.308447, 39.95913}, {116.308491, 39.958956},
            {116.308531, 39.958787}, {116.308573, 39.958616}, {116.308614, 39.958444}, {116.30863, 39.95834}, {116.30865, 39.958221}, {116.308688, 39.958031}, {116.30872, 39.95786}, {116.308754, 39.957677},
            {116.3088, 39.957468}, {116.308834, 39.957296}, {116.308866, 39.957128}, {116.308893, 39.956974}, {116.308905, 39.956878}, {116.308921, 39.956778}, {116.308938, 39.956679}, {116.308955, 39.956579},
            {116.308977, 39.956432}, {116.309003, 39.956258}, {116.309023, 39.956089}, {116.309041, 39.955912}, {116.309057, 39.95574}, {116.309075, 39.955564}, {116.30909, 39.955391}, {116.309105, 39.955219},
            {116.309119, 39.955044}, {116.309124, 39.95487}, {116.309127, 39.954697}, {116.309131, 39.954522}, {116.309135, 39.954346}, {116.309149, 39.954191}, {116.309174, 39.953785}, {116.309217, 39.953266},
            {116.309267, 39.952759}, {116.309304, 39.952241}, {116.309343, 39.951703}, {116.309381, 39.951161}, {116.30943, 39.950935}, {116.309481, 39.95076}, {116.30953, 39.950592}, {116.30958, 39.950425},
            {116.309615, 39.950252}, {116.309632, 39.950079}, {116.309651, 39.949864}, {116.309673, 39.949591}, {116.309693, 39.949338}, {116.309713, 39.949092}, {116.309733, 39.948843}, {116.309754, 39.948591},
            {116.309766, 39.948422}, {116.309779, 39.948247}, {116.30979, 39.948068}, {116.3098, 39.947894}, {116.30981, 39.947708}, {116.30982, 39.947545}, {116.309831, 39.947374}, {116.309845, 39.947166},
            {116.309857, 39.946988}, {116.30986, 39.946809}, {116.309858, 39.946647}, {116.309853, 39.946472}, {116.309853, 39.946312}, {116.309853, 39.946142}, {116.309857, 39.945958}, {116.309861, 39.945788},
            {116.309866, 39.945618}, {116.309871, 39.945426}, {116.309876, 39.945235}, {116.309881, 39.945025}, {116.309888, 39.944853}, {116.309898, 39.944676}, {116.309907, 39.944502}, {116.309918, 39.944311},
            {116.309927, 39.944137}, {116.309948, 39.943789}, {116.309973, 39.9434}, {116.309981, 39.943132}, {116.309988, 39.942888}, {116.309995, 39.942632}, {116.310003, 39.942397}, {116.310016, 39.942143},
            {116.310019, 39.941953}, {116.310018, 39.941778}, {116.310017, 39.941612}, {116.310016, 39.941429}, {116.310015, 39.941254}, {116.310015, 39.941082}, {116.310014, 39.940905}, {116.310013, 39.94073},
            {116.310012, 39.940556}, {116.310011, 39.94038}, {116.31001, 39.940206}, {116.310009, 39.94003}, {116.310008, 39.939857}, {116.310007, 39.939684}, {116.310006, 39.93951}, {116.310007, 39.939336},
            {116.31002, 39.939153}, {116.31002, 39.938903}, {116.31002, 39.938657}, {116.31002, 39.938404}, {116.310023, 39.938133}, {116.310044, 39.937646}, {116.310049, 39.937481}, {116.310054, 39.937308},
            {116.310059, 39.937132}, {116.310065, 39.936961}, {116.310071, 39.936783}, {116.310074, 39.936573}, {116.310074, 39.93632}, {116.310079, 39.936143}, {116.310085, 39.935965}, {116.310089, 39.935742},
            {116.310089, 39.935341}, {116.310092, 39.935081}, {116.310095, 39.934826}, {116.3101, 39.934517}, {116.310108, 39.934109}, {116.310113, 39.933778}, {116.310117, 39.933533}, {116.31012, 39.933282},
            {116.310123, 39.933032}, {116.310127, 39.932784}, {116.31013, 39.932532}, {116.310134, 39.932285}, {116.310134, 39.932153}, {116.310133, 39.932102}, {116.310132, 39.932052}, {116.310131, 39.932002},
            {116.31013, 39.931954}, {116.310129, 39.931903}, {116.310128, 39.931853}, {116.310126, 39.9318}, {116.310125, 39.931748}, {116.310124, 39.931699}, {116.310123, 39.931648}, {116.310122, 39.931599},
            {116.310121, 39.931548}, {116.31012, 39.931499}, {116.310119, 39.931449}, {116.310118, 39.9314}, {116.310116, 39.93135}, {116.310115, 39.931297}, {116.310114, 39.931248}, {116.310113, 39.9312},
            {116.310112, 39.931148}, {116.310111, 39.9311}, {116.31011, 39.93105}, {116.310109, 39.931}, {116.310107, 39.93095}, {116.310106, 39.9309}, {116.310105, 39.930849}, {116.310104, 39.930799},
            {116.310103, 39.930749}, {116.310102, 39.930699}, {116.310101, 39.930651}, {116.3101, 39.930601}, {116.310099, 39.930549}, {116.310097, 39.9305}, {116.310094, 39.930186}, {116.310089, 39.929673},
            {116.310093, 39.929424}, {116.310097, 39.929168}, {116.310097, 39.928808}, {116.310095, 39.928556}, {116.310094, 39.928317}, {116.310093, 39.928061}, {116.310092, 39.927818}, {116.31009, 39.927565},
            {116.310089, 39.927321}, {116.310089, 39.927072}, {116.31009, 39.92678}, {116.310094, 39.926383}, {116.310097, 39.925999}, {116.310101, 39.925825}, {116.310106, 39.925651}, {116.31011, 39.925477},
            {116.310115, 39.925299}, {116.310119, 39.925106}, {116.310124, 39.924934}, {116.310128, 39.924741}, {116.310132, 39.924492}, {116.310136, 39.924254}, {116.310138, 39.923972}, {116.31014, 39.923732},
            {116.310142, 39.923482}, {116.310144, 39.923242}, {116.310146, 39.922998}, {116.310148, 39.922743}, {116.310149, 39.922501}, {116.310147, 39.922004}, {116.310143, 39.921445}, {116.310139, 39.920919},
            {116.310135, 39.920361}, {116.310129, 39.919825}, {116.310129, 39.919281}, {116.310131, 39.918741}, {116.310134, 39.918138}, {116.310137, 39.917627}, {116.31014, 39.917092}, {116.310143, 39.916551},
            {116.310146, 39.916014}, {116.310148, 39.915476}, {116.310151, 39.914925}, {116.310153, 39.914378}, {116.310156, 39.913826}, {116.310158, 39.913276}, {116.310158, 39.912723}, {116.310159, 39.9122},
            {116.310165, 39.911671}, {116.31018, 39.911074}, {116.310182, 39.910538}, {116.310184, 39.909982}, {116.310185, 39.909449}, {116.310186, 39.908881}, {116.310187, 39.908351}, {116.31019, 39.907814},
            {116.310193, 39.907267}, {116.310196, 39.906757}, {116.310196, 39.906187}, {116.310196, 39.90567}, {116.3102, 39.905125}, {116.310204, 39.904537}, {116.310204, 39.903982}, {116.310204, 39.903371},
            {116.310204, 39.902857}, {116.310204, 39.902316}, {116.310209, 39.901767}, {116.310213, 39.901228}, {116.310217, 39.900684}, {116.310219, 39.900134}, {116.310219, 39.899585}, {116.310219, 39.899154},
            {116.310219, 39.898744}, {116.310219, 39.898436}, {116.310219, 39.898265}, {116.310219, 39.898089}, {116.310219, 39.897896}, {116.310219, 39.897726}, {116.310219, 39.897544}, {116.310219, 39.897377},
            {116.310219, 39.897194}, {116.310219, 39.897028}, {116.310219, 39.896852}, {116.310219, 39.896677}, {116.310219, 39.896497}, {116.310223, 39.896259}, {116.310228, 39.896018}, {116.310233, 39.895769},
            {116.310238, 39.895516}, {116.31024, 39.895243}, {116.310234, 39.894932}, {116.310234, 39.894682}, {116.310234, 39.894429}, {116.310234, 39.894172}, {116.310234, 39.893911}, {116.310235, 39.893719},
            {116.310236, 39.893521}, {116.310237, 39.893354}, {116.310238, 39.893178}, {116.310239, 39.892995}, {116.31024, 39.892828}, {116.310241, 39.892651}, {116.310242, 39.892479}, {116.310243, 39.892288},
            {116.310244, 39.892106}, {116.310245, 39.891939}, {116.310247, 39.891762}, {116.310248, 39.891581}, {116.310249, 39.891415}, {116.31025, 39.891196}, {116.31025, 39.89091}, {116.310251, 39.890671}, {116.310252, 39.890419}, {116.310253, 39.890163}, {116.310254, 39.889913}, {116.310254, 39.889643}, {116.310255, 39.889395}, {116.310256, 39.889141}, {116.310257, 39.8889}, {116.310258, 39.888702}, {116.31026, 39.88852}, {116.310262, 39.888351}, {116.310264, 39.888179}, {116.310266, 39.887988}, {116.310268, 39.887811}, {116.31027, 39.887638}, {116.310272, 39.887459}, {116.310272, 39.887224}, {116.310272, 39.886978}, {116.310274, 39.88678}, {116.31028, 39.886587}, {116.310285, 39.886406}, {116.310293, 39.886251}, {116.310305, 39.886076}, {116.310318, 39.885906}, {116.310337, 39.885731}, {116.310354, 39.885566}, {116.310368, 39.885383}, {116.310392, 39.88521}, {116.310421, 39.884994}, {116.310451, 39.88474}, {116.310479, 39.884503}, {116.310508, 39.884255}, {116.310539, 39.884}, {116.310561, 39.883694}, {116.310594, 39.883394}, {116.310619, 39.883199}, {116.310628, 39.883024}, {116.310635, 39.882851}, {116.310652, 39.882641}, {116.310679, 39.88236}, {116.310699, 39.882107}, {116.310721, 39.881829}, {116.310757, 39.881497}, {116.310805, 39.881095}, {116.310852, 39.880702}, {116.310888, 39.880437}, {116.310938, 39.880073}, {116.310989, 39.879695}, {116.311043, 39.879298}, {116.311099, 39.878883}, {116.31115, 39.878506}, {116.311179, 39.878252}, {116.311206, 39.878014}, {116.311233, 39.877769}, {116.311262, 39.87752}, {116.311291, 39.877261}, {116.311322, 39.876986}, {116.311349, 39.876749}, {116.311378, 39.876491}, {116.311406, 39.876245}, {116.311433, 39.876001}, {116.311461, 39.875753}, {116.311489, 39.875505}, {116.311517, 39.875257}, {116.311555, 39.874932}, {116.311602, 39.874539}, {116.311646, 39.874168}, {116.311699, 39.873636}, {116.31173, 39.873341}, {116.311748, 39.873174}, {116.311768, 39.873}, {116.31181, 39.872628}, {116.311866, 39.872131}, {116.311919, 39.871662}, {116.311938, 39.871495}, {116.311959, 39.871306}, {116.311983, 39.871088}, {116.312004, 39.870905}, {116.312035, 39.870635}, {116.312062, 39.870403}, {116.312092, 39.870141}, {116.312122, 39.869878}, {116.312153, 39.869617}, {116.31218, 39.869381}, {116.312211, 39.869119}, {116.312241, 39.868861}, {116.312269, 39.868616}, {116.312299, 39.868364}, {116.312328, 39.868116}, {116.312356, 39.867871}, {116.312387, 39.867588}, {116.312414, 39.867343}, {116.312441, 39.8671}, {116.312469, 39.866845}, {116.312488, 39.86667}, {116.312508, 39.866487}, {116.312526, 39.866315}, {116.312545, 39.866138}, {116.312564, 39.865966}, {116.312584, 39.865776}, {116.312603, 39.865601}, {116.312622, 39.865425}, {116.312641, 39.86525}, {116.312659, 39.865077}, {116.312721, 39.864643}, {116.312748, 39.864481}, {116.312777, 39.86431}, {116.312809, 39.864116}, {116.312836, 39.863953}, {116.312974, 39.86353}, {116.313092, 39.863168}, {116.313151, 39.862997}, {116.313216, 39.862812}, {116.313316, 39.862564}, {116.313394, 39.862394}, {116.313476, 39.862217}, {116.313569, 39.862023}, {116.313893, 39.86144}, {116.314256, 39.860891}, {116.314646, 39.860371}, {116.315063, 39.859874}, {116.315553, 39.85933}, {116.315993, 39.858858}, {116.316397, 39.858425}, {116.316828, 39.857939}, {116.317226, 39.857495}, {116.31763, 39.857044}, {116.31802, 39.856608}, {116.318465, 39.85611}, {116.318934, 39.855604}, {116.319419, 39.855072}, {116.319821, 39.854632}, {116.320245, 39.854167}, {116.320774, 39.853583}, {116.321303, 39.853007}, {116.321703, 39.852577}, {116.322227, 39.852041}, {116.322665, 39.85168}, {116.323179, 39.851293}, {116.323811, 39.850872}, {116.324332, 39.850566}, {116.324956, 39.850241}, {116.325619, 39.84995}, {116.326297, 39.849696}, {116.327077, 39.849449}, {116.327901, 39.849251}, {116.32869, 39.849097}, {116.329472, 39.848984}, {116.330352, 39.848927}, {116.331349, 39.84892}, {116.332282, 39.848919}, {116.33309, 39.848919}, {116.333817, 39.848919}, {116.334525, 39.848917}, {116.335236, 39.848907}, {116.336025, 39.848898}, {116.336811, 39.84889}, {116.337466, 39.848886}, {116.338179, 39.848885}, {116.338974, 39.848885}, {116.339742, 39.848885}, {116.340444, 39.848885}, {116.341202, 39.848896}, {116.342033, 39.848956}, {116.342724, 39.849021}, {116.343396, 39.849116}, {116.343913, 39.849195}, {116.344311, 39.84927}, {116.344603, 39.84933}, {116.344937, 39.849406}, {116.345335, 39.849508}, {116.345567, 39.849567}, {116.345811, 39.84963}, {116.346019, 39.849683}, {116.346263, 39.849746}, {116.346621, 39.849846}, {116.346977, 39.849944}, {116.347276, 39.850027}, {116.347568, 39.850108}, {116.347937, 39.850211}, {116.348404, 39.850334}, {116.348925, 39.850472}, {116.349194, 39.850547}, {116.349403, 39.850607}, {116.349619, 39.850665}, {116.349843, 39.850725}, {116.35009, 39.850791}, {116.350317, 39.850852}, {116.350536, 39.850911}, {116.35078, 39.85098}, {116.351003, 39.851043}, {116.351252, 39.851114}, {116.351471, 39.851175}, {116.351686, 39.851236}, {116.351904, 39.851297}, {116.352141, 39.851364}, {116.35235, 39.851423}, {116.352591, 39.851491}, {116.3528, 39.85155}, {116.353011, 39.85161}, {116.353233, 39.851672}, {116.353442, 39.851731}, {116.353695, 39.851803}, {116.353912, 39.851864}, {116.354119, 39.851919}, {116.354348, 39.851981}, {116.354567, 39.852041}, {116.354824, 39.852113}, {116.355045, 39.852176}, {116.355274, 39.85224}, {116.355505, 39.852305}, {116.355715, 39.852365}, {116.355944, 39.852429}, {116.356157, 39.852489}, {116.356366, 39.852548}, {116.356788, 39.852665}, {116.357325, 39.852814}, {116.357914, 39.852977}, {116.3584, 39.853111}, {116.358936, 39.85326}, {116.359509, 39.853418}, {116.360041, 39.853565}, {116.36055, 39.853706}, {116.360921, 39.853804}, {116.361419, 39.853947}, {116.361967, 39.854104}, {116.36233, 39.854206}, {116.36258, 39.854274}, {116.362825, 39.854341}, {116.363041, 39.854399}, {116.363322, 39.854476}, {116.363513, 39.854528}, {116.363581, 39.854547}, {116.363643, 39.854564}, {116.363713, 39.854583}, {116.363782, 39.854602}, {116.363845, 39.854619}, {116.363915, 39.854639}, {116.363979, 39.854656}, {116.36405, 39.854676}, {116.36413, 39.854698}, {116.3642, 39.854717}, {116.364271, 39.854736}, {116.364339, 39.854755}, {116.364407, 39.854774}, {116.364477, 39.854793}, {116.36455, 39.854813}, {116.364627, 39.854834}, {116.3647, 39.854854}, {116.364773, 39.854874}, {116.364842, 39.854893}, {116.364915, 39.854913}, {116.364989, 39.854934}, {116.365055, 39.854952}, {116.365137, 39.854975}, {116.365215, 39.854996}, {116.365285, 39.855015}, {116.365353, 39.855034}, {116.365433, 39.855056}, {116.365507, 39.855076}, {116.365578, 39.855096}, {116.365645, 39.855114}, {116.365731, 39.855138}, {116.365802, 39.855157}, {116.36588, 39.855179}, {116.366085, 39.855236}, {116.366339, 39.855307}, {116.366595, 39.855379}, {116.366827, 39.855444}, {116.367097, 39.855516}, {116.36738, 39.855595}, {116.367638, 39.855665}, {116.367889, 39.855733}, {116.368123, 39.855796}, {116.368782, 39.855974}, {116.369198, 39.856098}, {116.369567, 39.856206}, {116.369943, 39.856305}, {116.370362, 39.856416}, {116.370834, 39.856525}, {116.37109, 39.856574}, {116.371361, 39.856627}, {116.371656, 39.856684}, {116.371856, 39.85672}, {116.372023, 39.856745}, {116.372176, 39.856768}, {116.372328, 39.856791}, {116.372468, 39.856812}, {116.372622, 39.856835}, {116.372763, 39.856857}, {116.373037, 39.856887}, {116.373602, 39.856937}, {116.373982, 39.856968}, {116.374265, 39.85699}, {116.3749, 39.857024}, {116.375157, 39.857032}, {116.375461, 39.857042}, {116.375741, 39.857048}, {116.376019, 39.857047}, {116.37632, 39.857046}, {116.376623, 39.857046}, {116.376893, 39.857045}, {116.377169, 39.857044}, {116.377422, 39.857044}, {116.377721, 39.857043}, {116.377976, 39.857042}, {116.378254, 39.857042}, {116.378515, 39.857041}, {116.378787, 39.85704}, {116.379057, 39.85704}, {116.379335, 39.857039}, {116.379614, 39.857038}, {116.379889, 39.857037}, {116.380163, 39.857037}, {116.380442, 39.857038}, {116.380707, 39.857039}, {116.38097, 39.857039}, {116.38131, 39.85704}, {116.381699, 39.857044}, {116.381969, 39.857042}, {116.382256, 39.85704}, {116.382663, 39.857039}, {116.383068, 39.857038}, {116.383447, 39.857038}, {116.383827, 39.857036}, {116.384101, 39.857029}, {116.384459, 39.857024}, {116.38485, 39.857023}, {116.385284, 39.857021}, {116.385583, 39.857021}, {116.385867, 39.85702}, {116.386135, 39.85702}, {116.386418, 39.85702}, {116.386686, 39.857019}, {116.386977, 39.857019}, {116.387247, 39.857019}, {116.387539, 39.857018}, {116.387815, 39.857018}, {116.388365, 39.857016}, {116.388877, 39.857014}, {116.389153, 39.857014}, {116.389541, 39.857012}, {116.389965, 39.857009}, {116.390359, 39.857006}, {116.39059, 39.857006}, {116.390749, 39.857006}, {116.390917, 39.857006}, {116.391072, 39.857006}, {116.39124, 39.857006}, {116.391397, 39.857006}, {116.391566, 39.857006}, {116.392156, 39.857001}, {116.393008, 39.856993}, {116.393841, 39.856985}, {116.394592, 39.856995}, {116.395207, 39.857028}, {116.395678, 39.857043}, {116.395984, 39.857042}, {116.396285, 39.85704}, {116.396582, 39.857038}, {116.396857, 39.857037}, {116.397158, 39.857035}, {116.397438, 39.857033}, {116.397736, 39.857032}, {116.398017, 39.85703}, {116.398319, 39.857028}, {116.398602, 39.857027}, {116.39892, 39.857025}, {116.399205, 39.857023}, {116.399531, 39.857022}, {116.400096, 39.857021}, {116.400657, 39.85702}, {116.400959, 39.857017}, {116.401247, 39.857015}, {116.40156, 39.857012}, {116.401858, 39.857009}, {116.402164, 39.857006}, {116.402448, 39.857004}, {116.402755, 39.857001}, {116.403042, 39.856998}, {116.403352, 39.856995}, {116.403771, 39.856994}, {116.404212, 39.856992}, {116.404596, 39.856991}, {116.405021, 39.856988}, {116.405449, 39.856983}, {116.405901, 39.856987}, {116.406345, 39.856991}, {116.406761, 39.856995}, {116.407238, 39.856995}, {116.407587, 39.856998}, {116.407899, 39.857002}, {116.408207, 39.857006}, {116.408506, 39.857011}, {116.408819, 39.857015}, {116.409164, 39.857018}, {116.409622, 39.857018}, {116.409982, 39.857018}, {116.410295, 39.857019}, {116.4106, 39.85702}, {116.410924, 39.857021}, {116.411198, 39.857021}, {116.411898, 39.857021}, {116.412949, 39.857026}, {116.413999, 39.857033}, {116.415025, 39.85704}, {116.416104, 39.857047}, {116.417111, 39.857062}, {116.418165, 39.85707}, {116.419316, 39.857093}, {116.420263, 39.857175}, {116.421399, 39.857353}, {116.422345, 39.857516}, {116.423342, 39.857688}, {116.424255, 39.857845}, {116.425171, 39.858013}, {116.426379, 39.858163}, {116.427447, 39.858246}, {116.428504, 39.858308}, {116.429532, 39.85838}, {116.430576, 39.85845}, {116.431586, 39.858514}, {116.432604, 39.85858}, {116.433691, 39.858656}, {116.434712, 39.858726}, {116.435814, 39.858799}, {116.436873, 39.858856}, {116.438046, 39.858894}, {116.439034, 39.858894}, {116.440209, 39.858876}, {116.441294, 39.858844}, {116.44239, 39.858823}, {116.443516, 39.858805}, {116.44446, 39.858791}, {116.445643, 39.858802}, {116.446624, 39.858864}, {116.447744, 39.859046}, {116.448746, 39.859268}, {116.449776, 39.859604}, {116.450589, 39.859938}, {116.451633, 39.860476}, {116.45253, 39.861049}, {116.453171, 39.861427}, {116.453681, 39.86149}, {116.454033, 39.861485}, {116.454349, 39.86148}, {116.454688, 39.861475}, {116.455011, 39.86147}, {116.455482, 39.861452}, {116.455858, 39.861389}, {116.456304, 39.861143}, {116.456794, 39.860799}, {116.457335, 39.860389}, {116.457701, 39.860105}, {116.457921, 39.859929}, {116.458153, 39.859743}, {116.458372, 39.859569}, {116.458603, 39.859384}, {116.458821, 39.859209}, {116.459056, 39.859021}, {116.459327, 39.85881}, {116.459551, 39.858634}, {116.45979, 39.858448}, {116.460293, 39.858058}, {116.460765, 39.857693}, {116.461119, 39.857416}, {116.461457, 39.857148}, {116.461788, 39.856886}, {116.462152, 39.856598}, {116.462471, 39.856345}, {116.462815, 39.856073}, {116.463215, 39.855756}, {116.464008, 39.855134}, {116.4647, 39.854591}, {116.464954, 39.854386}, {116.465191, 39.854194}, {116.465426, 39.854005}, {116.465668, 39.853809}, {116.465913, 39.853611}, {116.466135, 39.853432}, {116.466374, 39.85324}, {116.46661, 39.853049}, {116.46709, 39.852644}, {116.467453, 39.852336}, {116.467677, 39.852143}, {116.467804, 39.852031}, {116.467935, 39.851916}, {116.468055, 39.851809}, {116.468193, 39.851687}, {116.468323, 39.851573}, {116.468454, 39.851457}, {116.468584, 39.851342}, {116.468713, 39.851229}, {116.468839, 39.851117}, {116.468971, 39.851001}, {116.469095, 39.850892}, {116.469236, 39.850766}, {116.469583, 39.850446}, {116.469898, 39.850156}, {116.470233, 39.849847}, {116.47039, 39.8497}, {116.470521, 39.849577}, {116.470646, 39.849458}, {116.470766, 39.849345}, {116.470909, 39.84921}, {116.471035, 39.849091}, {116.471156, 39.848976}, {116.471285, 39.848855}, {116.47141, 39.848737}, {116.471533, 39.84862}, {116.471662, 39.848499}, {116.471783, 39.848384}, {116.471914, 39.848261}, {116.472031, 39.848149}, {116.472167, 39.848022}, {116.472296, 39.8479}, {116.472418, 39.847784}, {116.472555, 39.847654}, {116.472686, 39.847531}, {116.472813, 39.847411}, {116.473323, 39.846932}, {116.47386, 39.846426}, {116.474353, 39.845963}, {116.474877, 39.84547}, {116.475369, 39.845007}, {116.475681, 39.844704}, {116.476119, 39.844298}, {116.476334, 39.844104}, {116.476965, 39.843511}, {116.477838, 39.842679}, {116.478753, 39.841803}, {116.479538, 39.841046}, {116.480295, 39.840339}, {116.481004, 39.839671}, {116.481783, 39.838933}, {116.482452, 39.838257}, {116.483251, 39.837544}, {116.483997, 39.836848}, {116.4848, 39.836068}, {116.485481, 39.835407}, {116.486315, 39.834585}, {116.487106, 39.833837}, {116.487774, 39.833206}, {116.488663, 39.832368}, {116.489408, 39.83167}, {116.490186, 39.830951}, {116.490932, 39.830274}, {116.49174, 39.829569}, {116.492558, 39.828856}, {116.493352, 39.82818}, {116.494138, 39.827532}, {116.495008, 39.826823}, {116.495897, 39.826104}, {116.496758, 39.825439}, {116.497643, 39.824741}, {116.498667, 39.823974}, {116.499712, 39.823204}, {116.500579, 39.822588}, {116.501612, 39.821861}, {116.502589, 39.821202}, {116.503609, 39.820526}, {116.50461, 39.819863}, {116.505466, 39.81932}, {116.506486, 39.818675}, {116.507445, 39.818078}, {116.50839, 39.817492}, {116.509443, 39.816836},
            {116.510285, 39.816307}, {116.511314, 39.815643}, {116.512329, 39.814987}, {116.512633, 39.81477}, {116.513358, 39.814285}, {116.513894, 39.813922}, {116.514191, 39.813713}, {116.514482, 39.813507}};

    private String TAG = "LocationService";
    private boolean quit;
    String str ="";
    private int hight = 0;
    private LocationBinder binder = new LocationBinder();
    @Nullable
    @Override
    public IBinder onBind(Intent intent) {
        Log.i(TAG,"Bind");
        return binder;
    }

    @Override
    public void onCreate() {
        System.out.println("onCreate location service");
        ComA = new SerialControl();
        ComB = new SerialIMUControl("/dev/ttyS0");
//        DispQueue = new DispQueueThread();
//        DispQueue.start();
//        AssistData = getAssistData();

        ComA.addDataListener(DataCache.getInstance());
        ComB.addDataListener(DataCache.getInstance());
        _sender=new UdpBroadCastSender();
//        DataCalcCallback aa = new DataCalcCallback();
        _dataInterface=new DataAnalyser(this);
        _sender = new LocalAnalyserSender(_dataInterface);
        _sender.start();
        ComA.setPort("/dev/ttyS1"); //  /dev/ttyS1为北斗/GPS串口，/dev/ttyS0为惯导数据采集串口

//                        ComA.setBaudRate(SpinnerBaudRateCOMA.getSelectedItem().toString());
        ComA.setBaudRate(9600);
        OpenComPort(ComA);

        ComB.setPort("/dev/ttyS0"); //  /dev/ttyS1为北斗/GPS串口，/dev/ttyS0为惯导数据采集串口
//                        ComB.setBaudRate(SpinnerBaudRateCOMA.getSelectedItem().toString());
        ComB.setBaudRate(115200);
        OpenComPort(ComB);
        if(null!=_dataInterface){
            _dataInterface.startCalc();
        }

        super.onCreate();
        startServce();
    }

    /**
     * 模拟下载任务，每秒钟更新一次
     */
    public void startServce(){
        HashMap<String ,String> map = new HashMap<>();
        final int[] count = {0};

//        map.put("height","76");
//        map.put("state","walk");
        Handler location_handler = new Handler();
        Runnable runnable = new Runnable(){
            @Override
            public void run() {


//                 {"time":"2020-10-23-10-31-02-001","longitude":"0.0","latitude":"0.0","height":"044330.0","state":" - ","length":"0.0","stepCounter":"0","stepLength":"0.0","speed":"0.0","angle":"31.315773242467305","method":"PDR"}
                JSONObject jsonObj = JSON.parseObject(getResult_str());
                String height = jsonObj.getString("height");
                String method = jsonObj.getString("method");
                map.put("method",method);

                boolean hasGPS = true;
                if(height.charAt(0)=='0'){
                    hasGPS=false;
                    height = height.substring(1);
                }
                double value = Float.valueOf(height);;
                DecimalFormat df = new DecimalFormat("########.00");
//四舍五入
                value = Double.parseDouble(df.format(value));
                height =String.valueOf(value);
                map.put("gpsConnection",String.valueOf(hasGPS));
                System.out.println(map.get("gpsConnection"));
                map.put("stepCounter",jsonObj.getString("stepCounter"));
                map.put("state",jsonObj.getString("state"));
                map.put("height",height);

                map.put("latitude",jsonObj.getString("latitude"));
                map.put("longitude",jsonObj.getString("longitude"));
//                int len = route_points.length;
//                map.put("stepCounter", String.valueOf(hight));
//                if(count[0] <len){
//                    map.put("latitude",String.valueOf(route_points[count[0]][1]));
//                    map.put("longitude",String.valueOf(route_points[count[0]][0]));
//                    count[0]++;
//                }else {
//                    map.put("latitude",String.valueOf(route_points[len-1][1]));
//                    map.put("longitude",String.valueOf(route_points[len-1][0]));
//                }
//
//                hight += 5;
//                hight = hight % 200;
                res = JSON.toJSONString(map);
                location_handler.postDelayed(this, 1000);
            }
        };

        location_handler.post(runnable);
    }

    public String getResult_str() {
        return result_str;
    }

    public void setResult_str(String result_str) {
        this.result_str = result_str;
    }


//
    public class LocationBinder extends Binder {
        /**
         * 获取当前Service的实例
         * @return
         */
        public LocationService getService(){
            return LocationService.this;
        }
    }
    /**
     * 解除绑定时调用
     * @return
     */
    @Override
    public boolean onUnbind(Intent intent) {
        Log.i(TAG, "Service is invoke onUnbind");
        return super.onUnbind(intent);
    }
    public String getLocation() {
            return res;
        }
    @Override
    public void onDestroy() {
        Log.i(TAG, "Service is invoke Destroyed");
        this.quit = true;
        super.onDestroy();
        CloseComPort(ComA);
        CloseComPort(ComB);
        closeUdpSender();
    }

    private void closeUdpSender() {
    }

    @Override
    public void onCalcFinish(Locate locate) {
        final String result = locate.getPose();
//        runOnUiThread(new Runnable() {
//            public void run() {
//                //显示计算结果信息
//                System.out.println("9999locat"+result);
//            }
//        });
      new Thread(new Runnable(){
          @Override
          public void run(){
              //处理事务
              setResult_str(result);
              System.out.println(result);
//
          }
      }).start();
    }


    //----------------------------------------------------串口控制类
    private class SerialControl extends SerialHelper {


        public SerialControl() {
        }

        public SerialControl(String sPort) {
            super(sPort);
        }

        @Override
        protected void onDataReceived(final ComBean ComRecData) {

            DispQueue.AddQueue(ComRecData);//线程定时刷新显示(推荐)

        }


    }

    /**
     * IMU串口处理
     */
    private class SerialIMUControl extends SerialControl {

        private static final int IMU_DATA_LENGTH = 23;//imu九轴数据长度
        private static final int HIGH_DATA_LENGTH = 21;//高度数据长度

//        public SerialIMUControl() {
//        }

        public SerialIMUControl(String sPort) {
            super(sPort);
        }

        @Override
        protected int getCmdStartIndex(byte[] buffer) {
            if (null != buffer
                    && buffer.length > 2) {
                for (int i = 0; i < buffer.length; i++) {
                    if ((i + 1) < buffer.length && (buffer[i] == CMD_START_9_AXIS_1_SYMBOL && buffer[i + 1] == CMD_START_9_AXIS_2_SYMBOL) || (buffer[i] == CMD_START_9_AXIS_1_SYMBOL && buffer[i + 1] == CMD_START_HIGH_COUNT_2_SYMBOL)) {
                        return i;
                    }
                }
            }
            return INVALIDE_INDEX;
        }

        @Override
        protected int getCmdStopIndex(int startIndex, byte[] buffer) {
            if (null != buffer
                    && buffer.length >= 2 && startIndex < buffer.length && startIndex >= 0  ) {
                if(buffer[startIndex+1]==CMD_START_9_AXIS_2_SYMBOL){
                    //九轴命令
                    if(buffer.length - startIndex >= IMU_DATA_LENGTH){
                        for (int i = startIndex + IMU_DATA_LENGTH -1; i < buffer.length; i++) {
                            if (buffer[i] == CMD_STOP_9_AXIS_SYMBOL ) {
                                //判断命令0xFF结束符
                                return i;
                            }
                        }
                    }

                }else if(buffer[startIndex+1]==CMD_START_HIGH_COUNT_2_SYMBOL){
                    //高度计数命令
                    if(buffer.length - startIndex >= HIGH_DATA_LENGTH){
                        for (int i = startIndex + HIGH_DATA_LENGTH -1; i < buffer.length; i++) {
                            if (buffer[i] == CMD_STOP_HIGH_COUNT_SYMBOL) {
                                //判断命令0xFF结束符
                                return i;
                            }
                        }
                    }
                }

            }
            return INVALIDE_INDEX;
        }

        @Override
        protected void onDataReceived(final ComBean ComRecData) {
            DispQueue.AddQueue(ComRecData);//线程定时刷新显示(推荐)
        }
    }

    //----------------------------------------------------刷新显示线程
    private class DispQueueThread extends Thread {
        private Queue<ComBean> QueueList = new LinkedList<ComBean>();

        @Override
        public void run() {
            super.run();
            while (!isInterrupted()) {
                final ComBean ComData;
//                while ((ComData = QueueList.poll()) != null) {
//                    runOnUiThread(new Runnable() {
//                        public void run() {
////                            DispRecData(ComData);
//                        }
//                    });
//                    try {
//                        Thread.sleep(100);//显示性能高的话，可以把此数值调小。
//                    } catch (Exception e) {
//                        e.printStackTrace();
//                    }
//                    break;
//                }
            }
        }

        public synchronized void AddQueue(ComBean ComData) {
            QueueList.add(ComData);
        }

        public synchronized void clear(){
            QueueList.clear();
        }
    }



    //----------------------------------------------------保存、获取界面数据
    private void saveAssistData(AssistBean AssistData) {

        SharedPreferences msharedPreferences = getSharedPreferences("EcictBdGpsCtrl", Context.MODE_PRIVATE);
        try {
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(baos);
            oos.writeObject(AssistData);
            String sBase64 = new String(android.util.Base64.encode(baos.toByteArray(), 0));
            SharedPreferences.Editor editor = msharedPreferences.edit();
            editor.putString("AssistData", sBase64);
            editor.commit();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    //----------------------------------------------------
    private AssistBean getAssistData() {
        SharedPreferences msharedPreferences = getSharedPreferences("EcictBdGpsCtrl", Context.MODE_PRIVATE);
        AssistBean AssistData = new AssistBean();
        try {
            String personBase64 = msharedPreferences.getString("AssistData", "");
            byte[] base64Bytes = Base64.decode(personBase64.getBytes(), 0);
            ByteArrayInputStream bais = new ByteArrayInputStream(base64Bytes);
            ObjectInputStream ois = new ObjectInputStream(bais);
            AssistData = (AssistBean) ois.readObject();
            return AssistData;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return AssistData;
    }

    //----------------------------------------------------设置自动发送延时
    private void SetiDelayTime(SerialHelper ComPort, String sTime) {
        ComPort.setiDelay(Integer.parseInt(sTime));
    }

    //----------------------------------------------------设置自动发送模式开关
    private void SetAutoSend(SerialHelper ComPort, boolean isAutoSend) {
        if (isAutoSend) {
            ComPort.startSend();
        } else {
            ComPort.stopSend();
        }
    }

    //----------------------------------------------------关闭串口
    private void CloseComPort(SerialHelper ComPort) {
        if (ComPort != null) {
            ComPort.stopSend();
            ComPort.close();
        }
    }

    //----------------------------------------------------打开串口
    private void OpenComPort(SerialHelper ComPort) {
        try {
            ComPort.open();
        } catch (SecurityException e) {
            ShowMessage("打开串口失败:没有串口读/写权限!");
        } catch (IOException e) {
            ShowMessage("打开串口失败:未知错误!");
        } catch (InvalidParameterException e) {
            ShowMessage("打开串口失败:参数错误!");
        }
    }//------------------------------------------显示消息
    private void ShowMessage(String sMsg) {
        Toast.makeText(this, sMsg, Toast.LENGTH_SHORT).show();
    }
}
